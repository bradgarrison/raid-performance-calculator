<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAID Performance Calculator</title>
  <meta name="description" content="Interactive RAID Performance Calculator — Compare read/write speeds, storage capacity, and redundancy for RAID levels.">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root { --bg1:#667eea; --bg2:#764ba2; --text:#333; --muted:#666; --primary:#007bff; --danger:#dc3545; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; margin:0; padding:20px; min-height:100vh; background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%); }
    .container { max-width:1200px; margin:0 auto; background:#fff; border-radius:15px; padding:30px; box-shadow:0 20px 40px rgba(0,0,0,.1); }
    h1 { text-align:center; color:var(--text); margin:.1em 0 .3em; font-size:2.2em; }
    .subtitle { text-align:center; color:var(--muted); margin-bottom:24px; font-size:1.05em; }
    .controls { display:flex; gap:16px; align-items:center; justify-content:center; flex-wrap:wrap; margin:20px 0 10px; }
    .drive-selector { display:flex; align-items:center; gap:10px; background:#f8f9fa; padding:8px 10px; border-radius:8px; border:1px solid #e9ecef; }
    .drive-selector label { font-weight:600; color:var(--text); }
    .drive-selector select { padding:8px 12px; border:2px solid var(--primary); border-radius:8px; font-size:1em; background:#fff; cursor:pointer; }
    .toggles { display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:10px; }
    .toggles label { background:#f8f9fa; padding:8px 10px; border-radius:8px; border:1px solid #e9ecef; color:#333; }
    .tab-buttons { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin:16px 0 10px; }
    .tab-btn { padding:10px 18px; border:none; border-radius:8px; background:#6c757d; color:#fff; cursor:pointer; transition:all .2s ease; }
    .tab-btn:hover { background:#5a6268; transform:translateY(-2px); }
    .tab-btn.active { background:var(--primary); box-shadow:0 4px 8px rgba(0,123,255,.3); }
    .chart-container { position:relative; height:420px; margin:18px 0; }
    .config-info { background:#e3f2fd; border-left:4px solid #2196f3; padding:18px; margin:12px 0; border-radius:0 8px 8px 0; }
    .config-info h4 { color:#1976d2; margin:0 0 10px; }
    .storage-info h4 { color:#856404; margin:0 0 8px; font-size:1.05em; }
    .storage-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:8px; }
    .storage-item { background:#fff; padding:12px; border-radius:8px; border:1px solid #dee2e6; }
    .storage-label { font-weight:600; color:#495057; font-size:.9em; margin-bottom:4px; }
    .storage-value { font-size:1.1em; color:#212529; }
    .storage-total { background:#e3f2fd; border-color:#2196f3; }
    .storage-usable { background:#e8f5e9; border-color:#4caf50; }
    .storage-lost { background:#ffebee; border-color:#f44336; }
    .explanation-text { margin:10px 0; line-height:1.6; color:#444; }
    .score-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; margin:14px 0; }
    .score-card { background:#fff; border:2px solid #e0e0e0; border-radius:10px; padding:14px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,.06); }
    .score-card h5 { margin:0 0 8px; color:#333; font-size:.9em; text-transform:uppercase; letter-spacing:.4px; }
    .score-value { font-size:1.7em; font-weight:800; margin:6px 0; }
    .score-description { font-size:.8em; color:#666; margin:0; }
    .score-excellent { color:#28a745; }
    .score-good { color:#17a2b8; }
    .score-fair { color:#ffc107; }
    .score-poor { color:#dc3545; }
    .inline-note { background:#fff; border:1px solid #dee2e6; border-radius:8px; padding:12px; margin-top:8px; }
    .inline-note h5 { margin:0 0 6px; font-size:.95em; color:#333; }
    .inline-note p { margin:0; color:#555; }
    .triangle-section { margin: 16px 0; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
    .triangle-bars { display: flex; flex-direction: column; gap: 12px; }
    .triangle-bar { display: flex; align-items: center; gap: 12px; }
    .triangle-label { flex: 0 0 180px; font-size: 0.9em; font-weight: 600; color: #333; }
    .triangle-progress { flex: 1; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; position: relative; }
    .triangle-fill { height: 100%; border-radius: 10px; transition: width 0.3s ease; }
    .triangle-value { flex: 0 0 40px; text-align: right; font-weight: 600; color: #333; font-size: 0.9em; }
    .warning-section { margin: 12px 0; }
    .warning-item { padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid; }
    .warning-item:last-child { margin-bottom: 0; }
    .warning-danger { background: #f8d7da; border-color: #dc3545; color: #721c24; }
    .warning-warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
    .warning-info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
    .warning-icon { font-weight: bold; margin-right: 8px; }
    .comparison-section { margin: 16px 0; }
    .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }
    .comparison-card { background: #fff; border: 2px solid #e0e0e0; border-radius: 10px; padding: 16px; }
    .comparison-current { border-color: #007bff; background: #f8f9ff; }
    .comparison-locked { border-color: #6c757d; background: #f8f9fa; }
    .comparison-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .comparison-title { font-weight: 600; color: #333; }
    .comparison-subtitle { font-size: 0.9em; color: #666; }
    .comparison-triangle { margin: 12px 0; }
    .comparison-triangle-bar { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .comparison-triangle-label { flex: 0 0 80px; font-size: 0.8em; font-weight: 600; }
    .comparison-triangle-progress { flex: 1; height: 16px; background: #e9ecef; border-radius: 8px; overflow: hidden; }
    .comparison-triangle-fill { height: 100%; border-radius: 8px; }
    .comparison-triangle-value { flex: 0 0 35px; text-align: right; font-weight: 600; font-size: 0.8em; }
    .comparison-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .comparison-stat { text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; }
    .comparison-stat-label { font-size: 0.7em; color: #666; text-transform: uppercase; margin-bottom: 2px; }
    .comparison-stat-value { font-weight: 600; color: #333; }
    .comparison-controls { display: flex; gap: 8px; justify-content: center; margin: 16px 0; }
    .comparison-btn { padding: 8px 16px; border: 1px solid #007bff; border-radius: 6px; background: #fff; color: #007bff; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
    .comparison-btn:hover { background: #007bff; color: #fff; }
    .comparison-btn.danger { border-color: #dc3545; color: #dc3545; }
    .comparison-btn.danger:hover { background: #dc3545; color: #fff; }
    .notes { background:#f8f9fa; border-left:4px solid var(--primary); padding:18px; margin:16px 0 0; border-radius:0 8px 8px 0; }
    .notes h3 { color:var(--primary); margin:0 0 8px; }
    .notes ul { margin:8px 0 0 18px; }
    .hidden { display:none !important; }
    .section-divider { border:0; border-top:1px solid #e9ecef; margin:12px 0; }
    .error { outline: 2px solid var(--danger); }
    @media (max-width: 768px) {
      .triangle-bar { flex-direction: column; align-items: stretch; gap: 6px; }
      .triangle-label { flex: none; text-align: center; }
      .triangle-value { text-align: center; }
      .controls { flex-direction: column; align-items: stretch; gap: 8px; }
      .drive-selector { justify-content: space-between; }
      .tab-buttons { gap: 8px; }
      .tab-btn { padding: 8px 12px; font-size: 0.9em; }
      .score-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; }
      .comparison-grid { grid-template-columns: 1fr; gap: 12px; }
      .comparison-stats { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>RAID Performance Calculator</h1>
    <p class="subtitle">Compare RAID configurations with your chosen drive count</p>
    <div class="controls" aria-label="Configuration controls">
      <div class="drive-selector">
        <label for="drive-count">Number of Drives:</label>
        <select id="drive-count">
          <option value="2">2 Drives</option>
          <option value="3">3 Drives</option>
          <option value="4" selected>4 Drives</option>
          <option value="5">5 Drives</option>
          <option value="6">6 Drives</option>
          <option value="7">7 Drives</option>
          <option value="8">8 Drives</option>
          <option value="9">9 Drives</option>
          <option value="10">10 Drives</option>
          <option value="11">11 Drives</option>
          <option value="12">12 Drives</option>
        </select>
      </div>
      <div class="drive-selector"><label><input type="checkbox" id="advanced-toggle"> Advanced options</label></div>
      <div class="drive-selector">
        <label for="drive-size">Drive Size (Optional):</label>
        <select id="drive-size">
          <option value="0">Not specified</option>
          <option value="0.5">500 GB</option>
          <option value="1">1 TB</option>
          <option value="2">2 TB</option>
          <option value="3">3 TB</option>
          <option value="4">4 TB</option>
          <option value="6">6 TB</option>
          <option value="8">8 TB</option>
          <option value="10">10 TB</option>
          <option value="12">12 TB</option>
          <option value="14">14 TB</option>
          <option value="16">16 TB</option>
          <option value="18">18 TB</option>
          <option value="20">20 TB</option>
          <option value="24">24 TB</option>
        </select>
      </div>
      <div class="drive-selector" id="mirror-wrapper">
        <label for="mirror-width">Mirror width:</label>
        <select id="mirror-width">
          <option value="2" selected>2-way</option>
          <option value="3">3-way</option>
        </select>
      </div>
      <div class="drive-selector" id="vdev-wrapper">
        <label for="vdev-width">RAIDZ vdev width:</label>
        <select id="vdev-width">
          <option value="4" selected>4</option>
          <option value="6">6</option>
          <option value="8">8</option>
          <option value="10">10</option>
          <option value="12">12</option>
        </select>
      </div>
      <div class="drive-selector" id="workload-wrapper">
        <label for="workload-mode">Workload:</label>
        <select id="workload-mode">
          <option value="seq" selected>File Server (large files)</option>
          <option value="rand">Database (small random writes)</option>
          <option value="vm">VM Host (mixed workload)</option>
          <option value="video">Video Editing (sequential)</option>
        </select>
      </div>
      <div class="drive-selector" id="perf-model-wrapper">
        <label for="perf-model">Performance Model:</label>
        <select id="perf-model">
          <option value="theoretical" selected>Theoretical</option>
          <option value="realistic">Real-World</option>
        </select>
      </div>
      <div class="drive-selector" id="ram-wrapper">
        <label for="system-ram">System RAM:</label>
        <select id="system-ram">
          <option value="8">8 GB</option>
          <option value="16">16 GB</option>
          <option value="32" selected>32 GB</option>
          <option value="64">64 GB</option>
          <option value="128">128 GB</option>
          <option value="256">256 GB</option>
        </select>
      </div>
      <div class="drive-selector" id="l2arc-wrapper">
        <label for="l2arc-size">L2ARC Cache:</label>
        <select id="l2arc-size">
          <option value="0">None</option>
          <option value="auto" selected>Auto (3x RAM)</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="drive-selector" id="l2arc-custom-wrapper" style="display: none;">
        <label for="l2arc-custom">L2ARC Size:</label>
        <select id="l2arc-custom">
          <option value="64">64 GB</option>
          <option value="128">128 GB</option>
          <option value="256">256 GB</option>
          <option value="512">512 GB</option>
          <option value="1024">1 TB</option>
          <option value="2048">2 TB</option>
        </select>
      </div>
    </div>
    <div class="toggles" id="advanced-toggles">
      <label><input type="checkbox" id="binary-units"> Use TiB (binary)</label>
      <label><input type="checkbox" id="reserve-10"> Reserve 10% free space</label>
      <label id="slog-wrapper"><input type="checkbox" id="slog-device"> Add SLOG device</label>
      <label id="special-wrapper"><input type="checkbox" id="special-vdev"> Add Special vdev (metadata)</label>
    </div>
    <div class="tab-buttons">
      <button class="tab-btn active" id="mirror-btn">RAID 1</button>
      <button class="tab-btn" id="raid0-btn">RAID 0</button>
      <button class="tab-btn" id="raid10-btn">RAID 10</button>
      <button class="tab-btn" id="raid5-btn">RAID 5</button>
      <button class="tab-btn" id="raid6-btn">RAID 6</button>
      <button class="tab-btn" id="raidz1-btn">RAIDZ1</button>
      <button class="tab-btn" id="raidz2-btn">RAIDZ2</button>
      <button class="tab-btn" id="raidz3-btn">RAIDZ3</button>
    </div>
    <div id="invalid-warning" class="inline-note hidden"></div>
    <div id="raid-explanation" class="config-info">
      <h4 id="explanation-title">Configuration Details</h4>
      <div id="explanation-content"></div>
      <div id="fault-tolerance" style="margin-top:8px; font-weight:600;"></div>
      <div id="scoring-section"></div>
    </div>
    <hr class="section-divider">
    <div class="chart-container">
      <canvas id="chart"></canvas>
    </div>
    <div class="storage-info">
      <h4>Storage Breakdown</h4>
      <div id="storage-display">
        <p style="text-align:center; color:#666; font-style:italic; margin:8px 0;">Select a drive size to see storage breakdown</p>
      </div>
    </div>
    <div id="rebuild-note" class="inline-note hidden">
      <h5>Rebuild time (estimate)</h5>
      <p id="rebuild-note-text"></p>
    </div>
  </div>
  <script>
    // Global state variables
    let chart = null;
    let currentDriveCount = 4;
    let currentRaidType = 'mirror';
    let currentDriveSize = 0;
    let mirrorWidth = 2;
    let vdevWidth = 4;
    let advancedMode = false;
    let workloadMode = 'seq';
    let perfModel = 'theoretical';
    let slogEnabled = false;
    let systemRam = 32;
    let l2arcSize = 'auto';
    let l2arcCustomSize = 256;
    let specialVdevEnabled = false;
    let comparisonMode = false;
    let lockedConfig = null;
    // Constants
    const RAID_LABEL = { 
      mirror:'RAID 1', raid0:'RAID 0', raid10:'RAID 10', 
      raid5:'RAID 5', raid6:'RAID 6', raidz1:'RAIDZ1', 
      raidz2:'RAIDZ2', raidz3:'RAIDZ3' 
    };
    const MIN_DRIVES = { 
      raid0:2, mirror:2, raid10:4, raid5:3, 
      raid6:4, raidz1:3, raidz2:4, raidz3:5 
    };
    // Initialize Chart.js
    const hasChart = typeof window.Chart !== 'undefined';
    if (hasChart) { Chart.defaults.color = '#333'; }
    // Progress bar color helper
    function getProgressBarColor(percentage) {
      if (percentage >= 80) {
        return '#28a745'; // Green for excellent (80-100%)
      } else if (percentage >= 60) {
        return '#17a2b8'; // Blue for good (60-79%)
      } else if (percentage >= 40) {
        return '#ffc107'; // Yellow for fair (40-59%)
      } else if (percentage >= 20) {
        return '#fd7e14'; // Orange for poor (20-39%)
      } else {
        return '#dc3545'; // Red for very poor (0-19%)
      }
    }
    
    // SLOG sizing calculation
    function calculateSlogSize(ramGB, workload) {
      const multipliers = {
        'seq': 2,     // File server
        'rand': 5,    // Database  
        'vm': 6,      // VM host
        'video': 2    // Video editing
      };
      
      const recommended = ramGB * multipliers[workload];
      const min = Math.max(8, ramGB * 2); // Minimum 2x RAM, but at least 8GB
      const max = Math.min(256, ramGB * 8); // Maximum 8x RAM, but cap at 256GB
      
      return {
        recommended: Math.min(256, Math.max(min, recommended)),
        min: min,
        max: max
      };
    }
    function configError(raidType, driveCount) {
      const min = MIN_DRIVES[raidType] || 1;
      if (driveCount < min) {
        return `${RAID_LABEL[raidType]} requires at least ${min} drives.`;
      }
      if (raidType === 'raid10' && (driveCount % mirrorWidth !== 0)) {
        return `RAID 10 requires a multiple of ${mirrorWidth} drives for ${mirrorWidth}-way mirrors.`;
      }
      return '';
    }
    // Performance calculation helpers
    function calcStripedMirrors(driveCount, width) {
      if (driveCount < width || driveCount % width !== 0) {
        return { read:0, write:0, usable:0, valid:false, vdevs:0 };
      }
      const vdevs = Math.floor(driveCount / width);
      return { read: driveCount, write: vdevs, usable: vdevs, valid: true, vdevs };
    }
    function calcRaidZ(driveCount, parity) {
      if (vdevWidth < parity + 1 || driveCount < vdevWidth) {
        return { read:0, write:0, usable:0, valid:false, vdevs:0 };
      }
      
      const vdevs = Math.floor(driveCount / vdevWidth);
      const leftover = driveCount % vdevWidth;
      if (vdevs === 0) {
        return { read:0, write:0, usable:0, valid:false, vdevs:0 };
      }
      
      const dataPerVdev = (vdevWidth - parity);
      const usable = vdevs * dataPerVdev;
      const read = vdevs * dataPerVdev;
      const penalty = 2 * (parity + 1);
      
      let writeSeq = vdevs * dataPerVdev;
      let writeRand = Math.max(0.25, (vdevs * dataPerVdev) / penalty);
      let writeMixed = Math.max(0.4, (vdevs * dataPerVdev) / (penalty * 0.7));
      
      if (perfModel === 'realistic') {
        writeSeq *= 0.8;
        writeRand *= 0.7;
        writeMixed *= 0.75;
      }
      
      let write;
      if (workloadMode === 'seq' || workloadMode === 'video') {
        write = writeSeq;
      } else if (workloadMode === 'rand') {
        write = slogEnabled ? vdevs * dataPerVdev * 0.8 : writeRand;
      } else if (workloadMode === 'vm') {
        write = slogEnabled ? vdevs * dataPerVdev * 0.8 : writeMixed;
      } else {
        write = writeSeq;
      }
      
      const valid = leftover === 0;
      return { read, write, usable, valid, vdevs };
    }
    // Main performance calculation
    function calculatePerformance(driveCount, raidType) {
      switch (raidType) {
        case 'raid0': {
          const n = driveCount;
          if (perfModel === 'realistic') {
            const scalingFactor = Math.min(1.0, 0.85 + (0.15 / Math.sqrt(n)));
            return { read: n * scalingFactor, write: n * scalingFactor, usable: n, valid: n >= 2 };
          } else {
            return { read: n, write: n, usable: n, valid: n >= 2 };
          }
        }
        case 'raid10': {
          const perf = calcStripedMirrors(driveCount, mirrorWidth);
          if (perfModel === 'realistic' && perf.valid) {
            const scalingFactor = Math.min(1.0, 0.9 + (0.1 / Math.sqrt(driveCount / mirrorWidth)));
            perf.read *= scalingFactor;
            perf.write *= scalingFactor;
          }
          return perf;
        }
        case 'mirror': {
          const perf = { read: driveCount, write: 1, usable: 1, valid: driveCount >= 2, vdevs: 1 };
          if (perfModel === 'realistic') {
            const readScaling = Math.min(1.0, 0.9 + (0.1 / Math.sqrt(driveCount)));
            perf.read *= readScaling;
          }
          return perf;
        }
        case 'raid5': {
          if (driveCount < 3) return { read:0, write:0, usable:0, valid:false };
          const n = driveCount;
          const read = Math.max(1, n - 1);
          const usable = n - 1;
          
          let writeSeq = 0.8 * (n - 1);
          let writeRand = Math.max(0.5, (n - 1) / 4);
          let writeMixed = Math.max(0.6, (n - 1) / 3);
          
          if (perfModel === 'realistic') {
            writeSeq *= 0.7;
            writeRand *= 0.6;
            writeMixed *= 0.65;
          }
          
          let write;
          if (workloadMode === 'seq' || workloadMode === 'video') {
            write = writeSeq;
          } else if (workloadMode === 'rand') {
            write = writeRand;
          } else if (workloadMode === 'vm') {
            write = writeMixed;
          } else {
            write = writeSeq;
          }
          return { read, write, usable, valid: true };
        }
        case 'raid6': {
          if (driveCount < 4) return { read:0, write:0, usable:0, valid:false };
          const n = driveCount;
          const read = Math.max(1, n - 2);
          const usable = n - 2;
          
          let writeSeq = 0.75 * (n - 2);
          let writeRand = Math.max(0.5, (n - 2) / 6);
          let writeMixed = Math.max(0.55, (n - 2) / 4.5);
          
          if (perfModel === 'realistic') {
            writeSeq *= 0.6;
            writeRand *= 0.5;
            writeMixed *= 0.55;
          }
          
          let write;
          if (workloadMode === 'seq' || workloadMode === 'video') {
            write = writeSeq;
          } else if (workloadMode === 'rand') {
            write = writeRand;
          } else if (workloadMode === 'vm') {
            write = writeMixed;
          } else {
            write = writeSeq;
          }
          return { read, write, usable, valid: true };
        }
        case 'raidz1': 
          return calcRaidZ(driveCount, 1);
        case 'raidz2': 
          return calcRaidZ(driveCount, 2);
        case 'raidz3': 
          return calcRaidZ(driveCount, 3);
        default: 
          return { read:1, write:1, usable:1, valid:true };
      }
    }
    // Triangle scoring calculation
    function calculateTriangleScores(raidType, driveCount, perf) {
      if (!perf.valid) return { cheap: 0, fast: 0, reliable: 0 };
      
      const cheap = (perf.usable / driveCount) * 100;
      const readPerf = (perf.read / driveCount) * 100;
      const writePerf = (perf.write / driveCount) * 100;
      const fast = (readPerf + writePerf) / 2;
      
      let reliable = 0;
      if (raidType === 'raid0') {
        reliable = 0;
      } else if (raidType === 'mirror') {
        reliable = Math.min(95, 60 + (driveCount - 2) * 10);
      } else if (raidType === 'raid10') {
        const vdevs = Math.floor(driveCount / mirrorWidth);
        reliable = Math.min(85, 50 + vdevs * 8);
      } else if (raidType === 'raid5') {
        reliable = Math.max(30, 70 - driveCount * 3);
      } else if (raidType === 'raid6') {
        reliable = Math.max(50, 85 - driveCount * 2);
      } else if (raidType.startsWith('raidz')) {
        const parity = raidType === 'raidz1' ? 1 : raidType === 'raidz2' ? 2 : 3;
        const vdevs = Math.floor(driveCount / vdevWidth);
        const baseReliability = parity === 1 ? 60 : parity === 2 ? 80 : 90;
        const vdevPenalty = Math.max(0, (vdevs - 1) * 8);
        const rebuildBonus = Math.max(0, (12 - vdevWidth) * 2);
        reliable = Math.min(95, Math.max(20, baseReliability - vdevPenalty + rebuildBonus));
      }
      
      return { cheap, fast, reliable };
    }
    // Rebuild scoring calculation
    function calculateRebuildScore(raidType, driveCount, usableCapacity) {
      if (raidType === 'raid0') {
        return { score: 'N/A', reason: 'No rebuild - restore from backup', timePerTB: null };
      }
      
      const baseScores = {
        'mirror': 9, 'raid10': 10, 'raid5': 6, 'raid6': 4, 'raidz1': 8, 'raidz2': 7, 'raidz3': 6
      };
      
      const baseScore = baseScores[raidType] || 5;
      let finalScore = baseScore;
      
      if (raidType === 'raid5') {
        const drivePenalty = Math.max(0, (driveCount - 3) * 1.2);
        finalScore = Math.max(1, baseScore - drivePenalty);
      } else if (raidType === 'raid6') {
        const drivePenalty = Math.max(0, (driveCount - 4) * 0.8);
        finalScore = Math.max(1, baseScore - drivePenalty);
      } else if (raidType.startsWith('raidz')) {
        const vdevs = Math.floor(driveCount / vdevWidth);
        const vdevPenalty = Math.max(0, (vdevs - 1) * 0.5);
        const sizePenalty = Math.max(0, (vdevWidth - 6) * 0.3);
        finalScore = Math.max(2, baseScore - vdevPenalty - sizePenalty);
      } else if (raidType === 'mirror') {
        const redundancyBonus = Math.min(2, (driveCount - 2) * 0.2);
        finalScore = Math.min(10, baseScore + redundancyBonus);
      }
      
      if (usableCapacity > 0) {
        const capacityPenalty = Math.max(0, (usableCapacity - 4) * 0.1);
        finalScore = Math.max(1, finalScore - capacityPenalty);
      }
      
      finalScore = Math.round(finalScore);
      
      const getLabel = (score) => score >= 8 ? 'Excellent' : score >= 6 ? 'Good' : score >= 4 ? 'Fair' : 'Poor';
      const getClass = (score) => score >= 8 ? 'score-excellent' : score >= 6 ? 'score-good' : score >= 4 ? 'score-fair' : 'score-poor';
      
      let reason;
      if (raidType === 'mirror') {
        reason = driveCount <= 3 ? 'Fast mirror resync' : 'Fast resync, high redundancy';
      } else if (raidType === 'raid10') {
        reason = 'Very fast parallel rebuilds';
      } else if (raidType === 'raid5') {
        if (driveCount <= 4) reason = 'Manageable rebuild time';
        else if (driveCount <= 8) reason = 'Long rebuild, array vulnerable';
        else reason = 'Very long rebuild, high URE risk';
      } else if (raidType === 'raid6') {
        if (driveCount <= 6) reason = 'Slow double parity rebuild';
        else reason = 'Very slow rebuild, extended vulnerability';
      } else if (raidType.startsWith('raidz')) {
        const vdevs = Math.floor(driveCount / vdevWidth);
        if (vdevs === 1) reason = 'Resilver only used blocks';
        else reason = `${vdevs} vdevs may rebuild concurrently`;
      }
      
      const timePerTB = {
        'mirror': 2, 'raid10': 1.5, 'raid5': Math.min(12, 4 + driveCount * 0.5), 
        'raid6': Math.min(15, 6 + driveCount * 0.8), 'raidz1': 4, 'raidz2': 5, 'raidz3': 6
      };
      
      return {
        score: finalScore,
        label: getLabel(finalScore),
        class: getClass(finalScore),
        reason: reason,
        timePerTB: timePerTB[raidType] || 4
      };
    }
    // Configuration warnings
    function getConfigWarnings(raidType, driveCount, usableCapacity) {
      const warnings = [];
      
      if (raidType === 'raid5') {
        if (driveCount >= 8) {
          warnings.push({
            level: 'danger',
            message: `RAID 5 with ${driveCount} drives has high URE risk during rebuilds. Consider RAID 6 or RAID 10.`
          });
        } else if (usableCapacity > 8) {
          warnings.push({
            level: 'warning', 
            message: `RAID 5 arrays >8TB have significant URE risk. Consider RAID 6 for better protection.`
          });
        } else if (driveCount >= 6) {
          warnings.push({
            level: 'warning',
            message: `RAID 5 rebuild times increase significantly with ${driveCount} drives.`
          });
        }
      }
      
      if (raidType === 'raid6') {
        if (driveCount >= 12) {
          warnings.push({
            level: 'warning',
            message: `RAID 6 with ${driveCount} drives has very long rebuild times. Consider RAID 10 or smaller arrays.`
          });
        } else if (usableCapacity > 20) {
          warnings.push({
            level: 'info',
            message: `Large RAID 6 arrays benefit from enterprise drives with lower URE rates.`
          });
        }
      }
      
      if (raidType === 'mirror') {
        if (driveCount >= 6) {
          warnings.push({
            level: 'warning',
            message: `Using ${driveCount} drives for RAID 1 is storage inefficient. Consider RAID 10 for better performance.`
          });
        } else if (driveCount >= 4) {
          warnings.push({
            level: 'info',
            message: `RAID 10 would give you better write performance than a ${driveCount}-way mirror.`
          });
        }
      }
      
      if (raidType === 'raidz1') {
        if (vdevWidth >= 10) {
          warnings.push({
            level: 'warning',
            message: `RAIDZ1 vdevs wider than 8-9 drives have poor performance. Consider RAIDZ2 or multiple smaller vdevs.`
          });
        } else if (Math.floor(driveCount / vdevWidth) >= 4) {
          warnings.push({
            level: 'info',
            message: `${Math.floor(driveCount / vdevWidth)} vdevs will rebuild concurrently if failures occur.`
          });
        }
      }
      
      if (raidType === 'raidz2') {
        if (vdevWidth >= 12) {
          warnings.push({
            level: 'warning',
            message: `RAIDZ2 vdevs wider than 10-11 drives have diminishing returns. Consider multiple smaller vdevs.`
          });
        }
      }
      
      if (raidType === 'raidz3') {
        if (vdevWidth < 7) {
          warnings.push({
            level: 'info',
            message: `RAIDZ3 with ${vdevWidth} drives has low storage efficiency. RAIDZ2 might be more practical.`
          });
        }
      }
      
      if (perfModel === 'realistic') {
        if ((raidType === 'raid5' || raidType === 'raid6') && driveCount >= 8) {
          warnings.push({
            level: 'info',
            message: `Real-world parity RAID performance is often 40-60% worse than theoretical calculations.`
          });
        }
      }
      
      if (usableCapacity > 50) {
        warnings.push({
          level: 'info',
          message: `Very large arrays benefit from enterprise-grade drives and controllers.`
        });
      }
      
      return warnings;
    }
    // Comparison mode functions
    function getCurrentConfig() {
      return {
        driveCount: currentDriveCount,
        raidType: currentRaidType,
        driveSize: currentDriveSize,
        mirrorWidth: mirrorWidth,
        vdevWidth: vdevWidth,
        workloadMode: workloadMode,
        perfModel: perfModel,
        slogEnabled: slogEnabled,
        systemRam: systemRam
      };
    }
    function applyConfig(config) {
      currentDriveCount = config.driveCount;
      currentRaidType = config.raidType;
      currentDriveSize = config.driveSize;
      mirrorWidth = config.mirrorWidth;
      vdevWidth = config.vdevWidth;
      workloadMode = config.workloadMode;
      perfModel = config.perfModel;
      slogEnabled = config.slogEnabled || false;
      systemRam = config.systemRam || 32;
      
      document.getElementById('drive-count').value = String(currentDriveCount);
      document.getElementById('drive-size').value = String(currentDriveSize);
      document.getElementById('mirror-width').value = String(mirrorWidth);
      document.getElementById('vdev-width').value = String(vdevWidth);
      document.getElementById('workload-mode').value = workloadMode;
      document.getElementById('perf-model').value = perfModel;
      document.getElementById('slog-device').checked = slogEnabled;
      document.getElementById('system-ram').value = String(systemRam);
      
      refreshVdevWidthOptions();
      maybeAutoSetRaidZWidth();
      updateRaidButtonsDisabledState();
      switchTab(currentRaidType);
    }
    function startComparison() {
      lockedConfig = getCurrentConfig();
      comparisonMode = true;
      render();
    }
    function swapConfigurations() {
      if (!lockedConfig) return;
      const temp = getCurrentConfig();
      applyConfig(lockedConfig);
      lockedConfig = temp;
      render();
    }
    function clearComparison() {
      lockedConfig = null;
      comparisonMode = false;
      render();
    }
    function renderComparisonCard(config, title, subtitle, isCurrent) {
      const perf = calculatePerformance(config.driveCount, config.raidType);
      const triangleScores = calculateTriangleScores(config.raidType, config.driveCount, perf);
      const rebuildScore = calculateRebuildScore(config.raidType, config.driveCount, config.driveSize > 0 ? perf.usable * config.driveSize : 0);
      
      const cardClass = isCurrent ? 'comparison-card comparison-current' : 'comparison-card comparison-locked';
      
      return `
        <div class="${cardClass}">
          <div class="comparison-header">
            <div>
              <div class="comparison-title">${title}</div>
              <div class="comparison-subtitle">${subtitle}</div>
            </div>
          </div>
          <div class="comparison-triangle">
            <div class="comparison-triangle-bar">
              <div class="comparison-triangle-label">Cheap</div>
              <div class="comparison-triangle-progress">
                <div class="comparison-triangle-fill" style="width: ${triangleScores.cheap}%; background: ${getProgressBarColor(triangleScores.cheap)};"></div>
              </div>
              <div class="comparison-triangle-value">${triangleScores.cheap.toFixed(0)}%</div>
            </div>
            <div class="comparison-triangle-bar">
              <div class="comparison-triangle-label">Fast</div>
              <div class="comparison-triangle-progress">
                <div class="comparison-triangle-fill" style="width: ${triangleScores.fast}%; background: ${getProgressBarColor(triangleScores.fast)};"></div>
              </div>
              <div class="comparison-triangle-value">${triangleScores.fast.toFixed(0)}%</div>
            </div>
            <div class="comparison-triangle-bar">
              <div class="comparison-triangle-label">Reliable</div>
              <div class="comparison-triangle-progress">
                <div class="comparison-triangle-fill" style="width: ${triangleScores.reliable}%; background: ${getProgressBarColor(triangleScores.reliable)};"></div>
              </div>
              <div class="comparison-triangle-value">${triangleScores.reliable.toFixed(0)}%</div>
            </div>
          </div>
          <div class="comparison-stats">
            <div class="comparison-stat">
              <div class="comparison-stat-label">Read Speed</div>
              <div class="comparison-stat-value">${perf.read.toFixed(1)}×</div>
            </div>
            <div class="comparison-stat">
              <div class="comparison-stat-label">Write Speed</div>
              <div class="comparison-stat-value">${perf.write.toFixed(1)}×</div>
            </div>
            <div class="comparison-stat">
              <div class="comparison-stat-label">Rebuild</div>
              <div class="comparison-stat-value">${rebuildScore.score === 'N/A' ? 'N/A' : rebuildScore.score + '/10'}</div>
            </div>
            <div class="comparison-stat">
              <div class="comparison-stat-label">Efficiency</div>
              <div class="comparison-stat-value">${((perf.usable / config.driveCount) * 100).toFixed(0)}%</div>
            </div>
          </div>
        </div>
      `;
    }
    // Main explanation and display functions
    function getRaidExplanation(raidType) {
      const perf = calculatePerformance(currentDriveCount, currentRaidType);
      const usableCapacity = currentDriveSize > 0 ? perf.usable * currentDriveSize : 0;
      const rebuildInfo = calculateRebuildScore(raidType, currentDriveCount, usableCapacity);
      
      const explanations = {
        'raid0': { title:'RAID 0 (Striping)', explanation:'Data is striped across all drives with no redundancy. Maximum performance and storage efficiency, but any drive failure destroys the entire array.', rebuild: rebuildInfo },
        'mirror': { title:'RAID 1 (Full Mirror)', explanation:'All drives contain identical data (a single mirrored set). Capacity is equal to one drive. Reads scale with the number of drives; writes are roughly equal to the speed of a single drive.', rebuild: rebuildInfo },
        'raid10': { title:'RAID 10 (Stripe of Mirrors)', explanation:`Mirrors striped together. ${mirrorWidth === 2 ? 'Traditional 2-way mirrors' : mirrorWidth === 3 ? '3-way mirrors for extra redundancy' : `${mirrorWidth}-way mirrors`} with excellent performance.`, rebuild: rebuildInfo },
        'raid5': { title:'RAID 5 (Single Parity)', explanation:'Distributes data and single parity across drives. Survives one failure; efficiency of N-1.', rebuild: rebuildInfo },
        'raid6': { title:'RAID 6 (Double Parity)', explanation:'Like RAID 5 but two parity blocks. Survives two failures; higher write penalty.', rebuild: rebuildInfo },
        'raidz1': { title:'RAIDZ1 (ZFS Single Parity)', explanation:`ZFS single parity with COW and checksums. Modeled as multiple equal-width vdevs.${slogEnabled ? ` SLOG device (${calculateSlogSize(systemRam, workloadMode).recommended}GB recommended) accelerates sync writes for databases/VMs.` : ''}`, rebuild: rebuildInfo },
        'raidz2': { title:'RAIDZ2 (ZFS Double Parity)', explanation:`ZFS double parity. Common sweet spot for capacity pools; modeled as multiple equal-width vdevs.${slogEnabled ? ` SLOG device (${calculateSlogSize(systemRam, workloadMode).recommended}GB recommended) accelerates sync writes for databases/VMs.` : ''}`, rebuild: rebuildInfo },
        'raidz3': { title:'RAIDZ3 (ZFS Triple Parity)', explanation:`ZFS triple parity for very large arrays. Modeled as multiple equal-width vdevs.${slogEnabled ? ` SLOG device (${calculateSlogSize(systemRam, workloadMode).recommended}GB recommended) accelerates sync writes for databases/VMs.` : ''}`, rebuild: rebuildInfo }
      };
      return explanations[raidType] || explanations['mirror'];
    }
    function failureTolerance(raidType) {
      if (raidType === 'raid0') return 'Tolerates 0 drive failures.';
      if (raidType === 'mirror') return `Tolerates up to ${Math.max(0, currentDriveCount - 1)} drive failures (as long as one drive remains).`;
      if (raidType === 'raid10') return `1 failure per vdev; can lose up to ${Math.floor(currentDriveCount / mirrorWidth)} drives if in different vdevs.`;
      if (raidType === 'raid5') return 'Tolerates 1 drive failure in the array.';
      if (raidType === 'raid6') return 'Tolerates 2 drive failures in the array.';
      if (raidType === 'raidz1') return 'Tolerates 1 drive failure across the pool (per vdev).';
      if (raidType === 'raidz2') return 'Tolerates 2 drive failures across the pool (per vdev).';
      if (raidType === 'raidz3') return 'Tolerates 3 drive failures across the pool (per vdev).';
      return '';
    }
    function setInvalidWarning() {
      const warn = document.getElementById('invalid-warning');
      const driveSel = document.getElementById('drive-count');
      if (!warn || !driveSel) return;
      
      const msg = configError(currentRaidType, currentDriveCount);
      const perf = calculatePerformance(currentDriveCount, currentRaidType);
      
      if (msg || !perf.valid){
        const reason = msg ? msg : `${RAID_LABEL[currentRaidType]} not possible with ${currentDriveCount} drives (vdev/layout mismatch).`;
        warn.innerHTML = `<h5>Invalid configuration</h5><p>${reason}</p>`;
        warn.classList.remove('hidden');
        driveSel.classList.add('error');
      } else {
        warn.classList.add('hidden');
        warn.innerHTML = '';
        driveSel.classList.remove('error');
      }
    }
    function updateRaidExplanation() {
      const e = getRaidExplanation(currentRaidType);
      document.getElementById('explanation-title').textContent = e.title;
      document.getElementById('explanation-content').innerHTML = `<div class="explanation-text">${e.explanation}</div>`;
      document.getElementById('fault-tolerance').textContent = failureTolerance(currentRaidType);
      
      const perf = calculatePerformance(currentDriveCount, currentRaidType);
      const msg = configError(currentRaidType, currentDriveCount);
      
      if (msg || !perf.valid){
        document.getElementById('scoring-section').innerHTML = `
          <div class="inline-note">
            <h5>Invalid configuration</h5>
            <p>${msg ? msg : `${RAID_LABEL[currentRaidType]} not possible with ${currentDriveCount} drives (vdev/layout mismatch).`}</p>
          </div>`;
        return;
      }
      const usableCapacity = currentDriveSize > 0 ? perf.usable * currentDriveSize : 0;
      const warnings = getConfigWarnings(currentRaidType, currentDriveCount, usableCapacity);
      const triangleScores = calculateTriangleScores(currentRaidType, currentDriveCount, perf);
      
      const norm = Math.max(1, currentDriveCount);
      const readScore = Math.min(10, Math.max(1, Math.round((perf.read / norm) * 10)));
      const writeScore = Math.min(10, Math.max(1, Math.round((perf.write / norm) * 10)));
      const scoreClass = (n) => n >= 8 ? 'score-excellent' : n >= 6 ? 'score-good' : n >= 4 ? 'score-fair' : 'score-poor';
      
      let warningsHtml = '';
      if (warnings.length > 0) {
        warningsHtml = `
          <div class="warning-section">
            ${warnings.map(w => `
              <div class="warning-item warning-${w.level}">
                <span class="warning-icon">${w.level === 'danger' ? '⚠️' : w.level === 'warning' ? '⚠️' : 'ℹ️'}</span>
                ${w.message}
              </div>
            `).join('')}
          </div>`;
      }
      
      const scoringHtml = `
        ${warningsHtml}
        <div class="triangle-section">
          <h5 style="margin: 0 0 12px; color: #333; text-align: center;">Cheap • Fast • Reliable Triangle</h5>
          <div class="triangle-bars">
            <div class="triangle-bar">
              <div class="triangle-label">Cheap (Storage Efficiency)</div>
              <div class="triangle-progress">
                <div class="triangle-fill" style="width: ${triangleScores.cheap}%; background: ${getProgressBarColor(triangleScores.cheap)};"></div>
              </div>
              <div class="triangle-value">${triangleScores.cheap.toFixed(0)}%</div>
            </div>
            <div class="triangle-bar">
              <div class="triangle-label">Fast (Performance)</div>
              <div class="triangle-progress">
                <div class="triangle-fill" style="width: ${triangleScores.fast}%; background: ${getProgressBarColor(triangleScores.fast)};"></div>
              </div>
              <div class="triangle-value">${triangleScores.fast.toFixed(0)}%</div>
            </div>
            <div class="triangle-bar">
              <div class="triangle-label">Reliable (Fault Tolerance)</div>
              <div class="triangle-progress">
                <div class="triangle-fill" style="width: ${triangleScores.reliable}%; background: ${getProgressBarColor(triangleScores.reliable)};"></div>
              </div>
              <div class="triangle-value">${triangleScores.reliable.toFixed(0)}%</div>
            </div>
          </div>
          <p style="font-size: 0.85em; color: #666; text-align: center; margin: 8px 0 0; font-style: italic;">
            Pick any two: You can't maximize all three simultaneously
          </p>
        </div>
        <div class="comparison-controls">
          ${!comparisonMode ? `<button class="comparison-btn" id="start-comparison-btn">Compare Configurations</button>` : `
            <button class="comparison-btn" id="swap-comparison-btn">Swap</button>
            <button class="comparison-btn danger" id="clear-comparison-btn">Clear</button>
          `}
        </div>
        ${comparisonMode && lockedConfig ? `
          <div class="comparison-section">
            <div class="comparison-grid">
              ${renderComparisonCard(getCurrentConfig(), 'Current Configuration', `${RAID_LABEL[currentRaidType]}, ${currentDriveCount} drives`, true)}
              ${renderComparisonCard(lockedConfig, 'Locked Configuration', `${RAID_LABEL[lockedConfig.raidType]}, ${lockedConfig.driveCount} drives`, false)}
            </div>
          </div>
        ` : ''}
        ${slogEnabled && currentRaidType.startsWith('raidz') ? `
          <div class="inline-note">
            <h5>SLOG Device Sizing</h5>
            <p>For ${systemRam}GB RAM with ${workloadMode === 'seq' ? 'File Server' : workloadMode === 'rand' ? 'Database' : workloadMode === 'vm' ? 'VM Host' : 'Video Editing'} workload: <strong>${calculateSlogSize(systemRam, workloadMode).recommended}GB recommended</strong> (range: ${calculateSlogSize(systemRam, workloadMode).min}-${calculateSlogSize(systemRam, workloadMode).max}GB). Use mirrored NVMe SSDs for redundancy.</p>
          </div>
        ` : ''}
        <div class="score-grid">
          <div class="score-card">
            <h5>Read</h5>
            <div class="score-value ${scoreClass(readScore)}">${readScore}/10</div>
            <div class="score-description">${perf.read.toFixed(1)}× vs single drive</div>
          </div>
          <div class="score-card">
            <h5>Write</h5>
            <div class="score-value ${scoreClass(writeScore)}">${writeScore}/10</div>
            <div class="score-description">${perf.write.toFixed(1)}× vs single drive (${workloadMode === 'seq' ? 'File Server' : workloadMode === 'rand' ? 'Database' : workloadMode === 'vm' ? 'VM Host' : 'Video Editing'})</div>
          </div>
          <div class="score-card">
            <h5>Rebuild</h5>
            <div class="score-value ${e.rebuild.class}">${e.rebuild.score === 'N/A' ? 'N/A' : e.rebuild.score + '/10'}</div>
            <div class="score-description">${e.rebuild.label}<br><em>${e.rebuild.reason}</em></div>
          </div>
        </div>`;
      
      document.getElementById('scoring-section').innerHTML = scoringHtml;
      
      // Add event listeners for comparison buttons
      const startBtn = document.getElementById('start-comparison-btn');
      if (startBtn) {
        startBtn.addEventListener('click', startComparison);
      }
      
      const swapBtn = document.getElementById('swap-comparison-btn');
      if (swapBtn) {
        swapBtn.addEventListener('click', swapConfigurations);
      }
      
      const clearBtn = document.getElementById('clear-comparison-btn');
      if (clearBtn) {
        clearBtn.addEventListener('click', clearComparison);
      }
    }
    function createChart() {
      if (!hasChart) {
        const container = document.querySelector('.chart-container');
        if (container) {
          container.innerHTML = '<div style="text-align:center;color:#666;padding:16px;">Chart unavailable (Chart.js blocked). Calculations still work.</div>';
        }
        return;
      }
      
      const ctx = document.getElementById('chart').getContext('2d');
      const driveCount = currentDriveCount;
      const perf = calculatePerformance(driveCount, currentRaidType);
      
      if (chart) chart.destroy();
      
      const msg = configError(currentRaidType, currentDriveCount);
      if (msg || !perf.valid) {
        chart = new Chart(ctx, {
          type: 'bar',
          data: { 
            labels: ['Invalid Configuration'], 
            datasets: [{ 
              label: 'Invalid', 
              data: [0], 
              backgroundColor: 'rgba(220,53,69,0.7)', 
              borderColor: 'rgba(220,53,69,1)', 
              borderWidth: 2 
            }] 
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              title: { display: true, text: msg || `${RAID_LABEL[currentRaidType]} not possible with ${driveCount} drives` }, 
              legend: { labels: { color: '#333' } } 
            },
            scales: { 
              y: { beginAtZero: true, ticks: { color: '#333' } }, 
              x: { ticks: { color: '#333' } } 
            }
          }
        });
        return;
      }
      
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Single Drive', `${driveCount} Drives (${RAID_LABEL[currentRaidType]})`],
          datasets: [
            { 
              label: 'Read Speed (x faster)', 
              data: [1, perf.read], 
              backgroundColor: 'rgba(54, 162, 235, 0.7)', 
              borderColor: 'rgba(54, 162, 235, 1)', 
              borderWidth: 2 
            },
            { 
              label: 'Write Speed (x faster)', 
              data: [1, perf.write], 
              backgroundColor: 'rgba(255, 99, 132, 0.7)', 
              borderColor: 'rgba(255, 99, 132, 1)', 
              borderWidth: 2 
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { 
              display: true, 
              text: `${RAID_LABEL[currentRaidType]} Performance with ${driveCount} Drives (${workloadMode === 'seq' ? 'File Server' : workloadMode === 'rand' ? 'Database' : workloadMode === 'vm' ? 'VM Host' : 'Video Editing'})` 
            },
            legend: { display: true, position: 'top', labels: { color: '#333' } }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Speed Multiplier' }, ticks: { color: '#333' } },
            x: { title: { display: true, text: 'Configuration' }, ticks: { color: '#333' } } 
          }
        }
      });
    }
    function updateStorageInfo() {
      const storageDisplay = document.getElementById('storage-display');
      const perf = calculatePerformance(currentDriveCount, currentRaidType);
      if (!storageDisplay) return;
      
      if (!currentDriveSize || currentDriveSize <= 0) {
        storageDisplay.innerHTML = '<p style="text-align:center; color:#666; font-style:italic; margin:8px 0;">Select a drive size to see storage breakdown</p>';
        return;
      }
      
      const msg = configError(currentRaidType, currentDriveCount);
      if (msg || !perf.valid) {
        storageDisplay.innerHTML = `<p style="text-align:center; color:#dc3545; font-style:italic;">${msg || `Invalid configuration for ${RAID_LABEL[currentRaidType]} with ${currentDriveCount} drives`}</p>`;
        return;
      }
      
      const useBinary = document.getElementById('binary-units').checked;
      const reserve10 = document.getElementById('reserve-10').checked;
      const unit = useBinary ? 'TiB' : 'TB';
      const factor = useBinary ? (1000/1024) : 1;
      
      let total = currentDriveSize * currentDriveCount;
      let usableDrives = perf.usable;
      let usableRaid = usableDrives * currentDriveSize;
      let usableAfterReserve = reserve10 ? usableRaid * 0.9 : usableRaid;
      
      total *= factor;
      usableRaid *= factor;
      usableAfterReserve *= factor;
      
      const lostToRaid = Math.max(0, total - usableRaid);
      const lostToReserve = Math.max(0, usableRaid - usableAfterReserve);
      const raidEff = total > 0 ? ((usableRaid / total) * 100).toFixed(1) : '0.0';
      
      storageDisplay.innerHTML = `
        <div class="storage-grid">
          <div class="storage-item storage-total">
            <div class="storage-label">Total Raw Space</div>
            <div class="storage-value">${total.toFixed(1)} ${unit}</div>
          </div>
          <div class="storage-item storage-usable">
            <div class="storage-label">Available Space${reserve10 ? ' (with 10% reserve)' : ''}</div>
            <div class="storage-value">${usableAfterReserve.toFixed(1)} ${unit}</div>
          </div>
          <div class="storage-item storage-lost">
            <div class="storage-label">Lost Space</div>
            <div class="storage-value">${(lostToRaid + lostToReserve).toFixed(1)} ${unit}</div>
          </div>
          <div class="storage-item">
            <div class="storage-label">RAID Efficiency</div>
            <div class="storage-value">${raidEff}%</div>
          </div>
        </div>`;
    }
    function updateRebuildNote() {
      const note = document.getElementById('rebuild-note');
      const noteText = document.getElementById('rebuild-note-text');
      if (!note || !noteText) return;
      
      const e = getRaidExplanation(currentRaidType);
      if (e.rebuild.timePerTB && currentDriveSize > 0) {
        const useBinary = document.getElementById('binary-units').checked;
        const estimatedHours = (currentDriveSize * e.rebuild.timePerTB).toFixed(1);
        note.classList.remove('hidden');
        noteText.textContent = `~${estimatedHours} hours to rebuild one failed ${currentDriveSize}${useBinary ? ' TiB' : ' TB'} drive.`;
      } else {
        note.classList.add('hidden');
        noteText.textContent = '';
      }
    }
    function applyAdvancedVisibility() {
      const advToggles = document.getElementById('advanced-toggles');
      const vdevWrap = document.getElementById('vdev-wrapper');
      const mirrorWrap = document.getElementById('mirror-wrapper');
      const workloadWrap = document.getElementById('workload-wrapper');
      const perfModelWrap = document.getElementById('perf-model-wrapper');
      const ramWrap = document.getElementById('ram-wrapper');
      const slogWrap = document.getElementById('slog-wrapper');
      const l2arcWrap = document.getElementById('l2arc-wrapper');
      const specialWrap = document.getElementById('special-wrapper');
      const isRaidZ = currentRaidType && currentRaidType.startsWith('raidz');
      const isRaid10 = currentRaidType === 'raid10';
      
      if (advToggles) advToggles.classList.toggle('hidden', !advancedMode);
      if (vdevWrap) vdevWrap.classList.toggle('hidden', !advancedMode || !isRaidZ);
      if (mirrorWrap) mirrorWrap.classList.toggle('hidden', !advancedMode || !isRaid10);
      if (workloadWrap) workloadWrap.classList.toggle('hidden', !advancedMode);
      if (perfModelWrap) perfModelWrap.classList.toggle('hidden', !advancedMode);
      if (ramWrap) ramWrap.classList.toggle('hidden', !advancedMode);
      if (slogWrap) slogWrap.classList.toggle('hidden', !advancedMode || !isRaidZ);
      if (l2arcWrap) l2arcWrap.classList.toggle('hidden', !advancedMode || !isRaidZ);
      if (specialWrap) specialWrap.classList.toggle('hidden', !advancedMode || !isRaidZ);
    }
    function pickDefaultRaidZWidth(driveCount, parity) {
      const preferred = [4,6,8,10,12,14,16,5,7,9,11,13,15];
      const candidate = preferred.filter(w => w <= driveCount && w >= (parity+1) && (driveCount % w === 0)).pop();
      return candidate || Math.max(parity+1, Math.min(driveCount, 16));
    }
    function maybeAutoSetRaidZWidth() {
      if (!currentRaidType.startsWith('raidz') || advancedMode) return;
      const parity = currentRaidType === 'raidz1' ? 1 : currentRaidType === 'raidz2' ? 2 : 3;
      const auto = pickDefaultRaidZWidth(currentDriveCount, parity);
      vdevWidth = auto;
      const sel = document.getElementById('vdev-width');
      if (sel) sel.value = String(vdevWidth);
    }
    function updateRaidButtonsDisabledState() {
      const types = ['mirror','raid0','raid10','raid5','raid6','raidz1','raidz2','raidz3'];
      types.forEach(t => {
        const btn = document.getElementById(`${t}-btn`);
        if (!btn) return;
        const err = configError(t, currentDriveCount);
        btn.disabled = !!err;
        btn.style.opacity = err ? 0.6 : 1;
        btn.title = err ? err : RAID_LABEL[t];
      });
    }
    function switchTab(type) {
      currentRaidType = type;
      ['mirror','raid0','raid10','raid5','raid6','raidz1','raidz2','raidz3'].forEach(id => {
        const btn = document.getElementById(`${id}-btn`);
        btn.classList.toggle('active', id === type);
      });
      refreshVdevWidthOptions();
      maybeAutoSetRaidZWidth();
      applyAdvancedVisibility();
      render();
    }
    function render() {
      updateRaidExplanation();
      createChart();
      updateStorageInfo();
      updateRebuildNote();
      setInvalidWarning();
      const state = { 
        c: currentDriveCount, t: currentRaidType, s: currentDriveSize, 
        mw: mirrorWidth, vw: vdevWidth, adv: advancedMode, 
        wl: workloadMode, pm: perfModel, slog: slogEnabled, ram: systemRam, comp: comparisonMode, locked: lockedConfig 
      };
      try { localStorage.setItem('raidcalc', JSON.stringify(state)); } catch(e) {}
      applyAdvancedVisibility();
    }
    function refreshVdevWidthOptions() {
      const sel = document.getElementById('vdev-width');
      const was = vdevWidth;
      const isRaidZ = currentRaidType.startsWith('raidz');
      let parity = 0;
      if (currentRaidType === 'raidz1') parity = 1;
      else if (currentRaidType === 'raidz2') parity = 2;
      else if (currentRaidType === 'raidz3') parity = 3;
      const upper = Math.min(currentDriveCount, 16);
      const divisible = [];
      for (let w = Math.max(parity + 1, 2); w <= upper; w++) {
        if (currentDriveCount % w === 0) divisible.push(w);
      }
      if (sel) {
        sel.innerHTML = '';
        const list = isRaidZ ? divisible : [4, 6, 8, 10, 12];
        list.forEach(w => {
          const opt = document.createElement('option');
          opt.value = String(w);
          opt.textContent = String(w);
          sel.appendChild(opt);
        });
      }
      if (isRaidZ) {
        const fallback = divisible.length ? divisible[divisible.length - 1] : Math.max(parity + 1, Math.min(currentDriveCount, 16));
        vdevWidth = divisible.includes(was) ? was : fallback;
        if (sel) sel.value = String(vdevWidth);
      }
    }
    // Event listeners
    document.getElementById('drive-count').addEventListener('change', (e) => {
      currentDriveCount = parseInt(e.target.value,10);
      refreshVdevWidthOptions();
      maybeAutoSetRaidZWidth();
      updateRaidButtonsDisabledState();
      render();
    });
    document.getElementById('drive-size').addEventListener('change', (e) => {
      currentDriveSize = parseFloat(e.target.value); 
      render();
    });
    document.getElementById('mirror-width').addEventListener('change', (e) => {
      mirrorWidth = parseInt(e.target.value,10); 
      render();
    });
    document.getElementById('vdev-width').addEventListener('change', (e) => {
      vdevWidth = parseInt(e.target.value,10); 
      render();
    });
    document.getElementById('binary-units').addEventListener('change', render);
    document.getElementById('reserve-10').addEventListener('change', render);
    document.getElementById('slog-device').addEventListener('change', (e) => {
      slogEnabled = !!e.target.checked;
      render();
    });
    
    document.getElementById('system-ram').addEventListener('change', (e) => {
      systemRam = parseInt(e.target.value, 10);
      render();
    });
    
    document.getElementById('l2arc-size').addEventListener('change', (e) => {
      l2arcSize = e.target.value;
      const customWrapper = document.getElementById('l2arc-custom-wrapper');
      if (customWrapper) {
        customWrapper.style.display = l2arcSize === 'custom' ? 'flex' : 'none';
      }
      render();
    });
    
    document.getElementById('l2arc-custom').addEventListener('change', (e) => {
      l2arcCustomSize = parseInt(e.target.value, 10);
      render();
    });
    
    document.getElementById('special-vdev').addEventListener('change', (e) => {
      specialVdevEnabled = !!e.target.checked;
      render();
    });
    
    const advToggleEl = document.getElementById('advanced-toggle');
    if (advToggleEl) {
      advToggleEl.addEventListener('change', (e) => {
        advancedMode = !!e.target.checked;
        applyAdvancedVisibility();
        render();
      });
    }
    
    const workloadSel = document.getElementById('workload-mode');
    if (workloadSel) {
      workloadSel.addEventListener('change', (e) => { 
        workloadMode = e.target.value; 
        render(); 
      });
    }
    
    const perfModelSel = document.getElementById('perf-model');
    if (perfModelSel) {
      perfModelSel.addEventListener('change', (e) => { 
        perfModel = e.target.value; 
        render(); 
      });
    }
    ['mirror','raid0','raid10','raid5','raid6','raidz1','raidz2','raidz3'].forEach(id => {
      document.getElementById(`${id}-btn`).addEventListener('click', () => { 
        switchTab(id); 
      });
    });
    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const st = JSON.parse(localStorage.getItem('raidcalc')||'{}');
        if (st.c) { currentDriveCount = st.c; document.getElementById('drive-count').value = String(st.c); }
        if (st.s!=null) { currentDriveSize = st.s; document.getElementById('drive-size').value = String(st.s); }
        if (st.mw) { mirrorWidth = st.mw; document.getElementById('mirror-width').value = String(st.mw); }
        if (st.vw) { vdevWidth = st.vw; }
        if (st.t) { currentRaidType = st.t; }
        if (typeof st.adv !== 'undefined') { advancedMode = !!st.adv; }
        if (st.wl) { workloadMode = st.wl; const sel = document.getElementById('workload-mode'); if (sel) sel.value = workloadMode; }
        if (st.pm) { perfModel = st.pm; const sel = document.getElementById('perf-model'); if (sel) sel.value = perfModel; }
        if (typeof st.slog !== 'undefined') { slogEnabled = !!st.slog; document.getElementById('slog-device').checked = slogEnabled; }
        if (st.ram) { systemRam = st.ram; document.getElementById('system-ram').value = String(st.ram); }
        if (typeof st.comp !== 'undefined') { comparisonMode = !!st.comp; }
        if (st.locked) { lockedConfig = st.locked; }
      } catch(e) {}
      
      document.getElementById('advanced-toggle').checked = advancedMode;
      applyAdvancedVisibility();
      refreshVdevWidthOptions();
      maybeAutoSetRaidZWidth();
      updateRaidButtonsDisabledState();
      switchTab(currentRaidType);
    });
  </script>
</body>
</html>
